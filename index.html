<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Goalie Tracker – iPhone (v2.9)</title>
<style>
  :root{
    --bg:#0b0e11; --panel:#141922; --ink:#e8ecf1; --muted:#9aa6b2; --accent:#4da3ff;
    --good:#35c759; --warn:#ff9f0a; --bad:#ff453a; --btn:#1f2a38; --btn2:#243041; --radius:14px;
  }
  html,body{height:100%}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Helvetica,Arial,sans-serif;
       background:var(--bg);color:var(--ink)}
  .wrap{max-width:520px;margin:0 auto;padding:14px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:6px 0 10px}
  header h1{font-size:20px;margin:0;letter-spacing:.2px}
  .tag{font-size:12px;color:var(--muted)}
  .panel{background:var(--panel);border-radius:var(--radius);padding:12px;box-shadow:0 6px 18px rgba(0,0,0,.25)}
  .row{display:flex;gap:10px}.col{flex:1}
  label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
  input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #2a3444;background:var(--btn);color:var(--ink);font-size:14px;outline:none}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
  .btn{-webkit-tap-highlight-color:transparent;background:var(--btn2);color:var(--ink);border:none;padding:16px 14px;border-radius:14px;font-size:16px;font-weight:600;box-shadow:0 6px 12px rgba(0,0,0,.22);touch-action:manipulation;user-select:none;cursor:pointer}
  .btn:active{transform:scale(.98)}
  .btn.shot{background:#1e2f47}.btn.goal{background:#3a2230}.btn.soft{background:#4b2430}.btn.smother{background:#1d3b2a}
  .btn.bad{background:#3b2a1d}.btn.big{background:#1d2f3b}.btn.undo{background:#2b3240}.btn.period{background:#2a2f3a}
  .btn.end{background:linear-gradient(180deg,#345e2f,#1f381c)}
  .btn.roster{background:#20324a;padding:10px 12px;font-size:14px}
  .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:12px}
  .card{background:#101520;border:1px solid #233044;border-radius:12px;padding:10px}
  .card h3{margin:0 0 2px;font-size:12px;color:var(--muted)} .card .val{font-size:18px;font-weight:700}
  .periods{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin-top:4px}
  .chip{text-align:center;padding:10px 8px;border-radius:10px;border:1px solid #2a3444;background:#152030;font-weight:700;cursor:pointer;user-select:none}
  .chip.active{background:#1b3352;border-color:#2f5e9a;color:#cfe5ff}
  .log{margin-top:10px;max-height:180px;overflow:auto;border:1px solid #233044;border-radius:12px;padding:8px;background:#0f141d}
  .log .item{font-size:13px;padding:6px 4px;border-bottom:1px dashed #202b3b}.log .item:last-child{border-bottom:none}
  .foot-actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .small{font-size:12px;color:var(--muted)}
  .score{font-size:44px;font-weight:800;letter-spacing:1px}
  .good{color:var(--good)}.warn{color:var(--warn)}.bad{color:var(--bad)}
  .hidden{display:none}
  .banner{margin-top:8px;padding:8px 10px;border-radius:10px;background:#0e1a2a;border:1px solid #224064;color:#cfe5ff;font-size:12px}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
  .modal .box{background:#0e1320;border:1px solid #2a3a55;border-radius:12px;max-width:520px;width:100%;padding:12px}
  .modal textarea{width:100%;height:220px;background:#0b1220;color:#e8ecf1;border:1px solid #243248;border-radius:10px;padding:8px;font-size:14px}
  .modal .rowbtn{display:flex;gap:10px;margin-top:8px}
  .mini{font-size:11px;color:#a6b3c2}
  .pgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
  .pchip{background:#0f1a28;border:1px solid #223045;border-radius:10px;padding:8px}
  .pchip h4{margin:0 0 4px;font-size:11px;color:#9ab7d6}
  .pchip div{font-size:13px;font-weight:700}
  .pickerGrid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px}
  .pickerBtn{background:#152033;border:1px solid #2a3c5a;border-radius:10px;padding:12px 8px;text-align:center;font-weight:800;cursor:pointer}
  .inlineRow{display:flex;gap:8px;align-items:center}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Goalie Tracker</h1>
    <div class="inlineRow">
      <button class="btn roster" id="btnRoster" type="button" aria-haspopup="dialog" aria-controls="rosterModal">Roster</button>
      <div class="tag" id="gameMetaTag">New game</div>
    </div>
  </header>

  <section class="panel" id="setupPanel">
    <div class="row">
      <div class="col"><label for="opponent">Opponent</label><input id="opponent" placeholder="e.g., Napanee Stars" autocomplete="off"></div>
      <div class="col"><label for="level">Level</label>
        <select id="level"><option>U9</option><option selected>U11</option><option>U13</option><option>U15</option><option>U18</option><option>Other</option></select>
      </div>
    </div>
    <div class="row" style="margin-top:8px;">
      <div class="col"><label for="date">Date</label><input id="date" type="date"></div>
      <div class="col">
        <label>Current Period</label>
        <div class="periods" id="periodChips">
          <div class="chip active" data-p="1" role="button" aria-pressed="true">1</div>
          <div class="chip" data-p="2" role="button" aria-pressed="false">2</div>
          <div class="chip" data-p="3" role="button" aria-pressed="false">3</div>
          <div class="chip" data-p="4" role="button" aria-pressed="false">OT</div>
        </div>
      </div>
    </div>
    <div class="small">Row 1 = saves, Row 2 = goals, Row 3 = rebounds, Row 4 = our offense (with player picker), bottom rows = controls.</div>
    <div id="resumeBanner" class="banner hidden">Resumed saved game.</div>
    <div id="persistBanner" class="banner hidden">Storage locked in. Your game will resume even after long pauses.</div>
  </section>

  <section class="panel" style="margin-top:12px;">
    <div class="grid">
      <!-- Row 1 -->
      <button class="btn shot" id="btnShot" type="button">Shot (Saved)</button>
      <button class="btn big" id="btnBigSave" type="button">Big Save</button>
      <!-- Row 2 -->
      <button class="btn goal" id="btnGoal" type="button">Goal</button>
      <button class="btn soft" id="btnSoftGoal" type="button">Soft Goal</button>
      <!-- Row 3 -->
      <button class="btn smother" id="btnSmother" type="button">Smother</button>
      <button class="btn bad" id="btnBadRebound" type="button">Bad Rebound</button>
      <!-- Row 4 -->
      <button class="btn" id="btnForShot" type="button">Our Shot</button>
      <button class="btn" id="btnForGoal" type="button">Our Goal</button>
      <!-- Row 5 -->
      <button class="btn undo" id="btnUndo" type="button">Undo</button>
      <button class="btn period" id="btnNextPeriod" type="button">Next Period</button>
    </div>

    <div class="stats" id="stats">
      <div class="card"><h3>Shots Against</h3><div class="val" id="shotsVal">0</div></div>
      <div class="card"><h3>Saves</h3><div class="val" id="savesVal">0</div></div>
      <div class="card"><h3>Goals Against</h3><div class="val" id="gaVal">0</div></div>
      <div class="card"><h3>Save %</h3><div class="val" id="svVal">—</div></div>
      <div class="card"><h3>Smothers</h3><div class="val" id="smotherVal">0</div></div>
      <div class="card"><h3>Bad Rebounds</h3><div class="val" id="brVal">0</div></div>
      <div class="card"><h3>Big Saves</h3><div class="val" id="bigVal">0</div></div>
      <div class="card"><h3>Shots For</h3><div class="val" id="sfVal">0</div></div>
      <div class="card"><h3>Goals For</h3><div class="val" id="gfVal">0</div></div>
      <div class="card"><h3>Shot Share</h3><div class="val" id="ssVal">—</div></div>
    </div>

    <div class="pgrid" id="periodSummary"></div>
    <div class="log" id="log"></div>

    <div class="foot-actions">
      <button class="btn end" id="btnEnd" type="button">End Game & Score</button>
      <button class="btn undo" id="btnReset" type="button">New Game</button>
    </div>

    <div class="row" style="margin-top:10px;">
      <button class="btn" id="btnBackup" type="button">Backup</button>
      <button class="btn" id="btnRestore" type="button">Restore</button>
    </div>
  </section>

  <section class="panel hidden" id="summaryPanel" style="margin-top:12px;">
    <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;">
      <div><div class="small" id="summaryTitle">Summary</div><div id="scoreNum" class="score">—</div></div>
      <div class="card" style="min-width:180px;"><h3>Breakdown</h3><div class="small" id="scoreBreakdown"></div></div>
    </div>
    <div class="mini" id="byPeriodLines" style="margin-top:6px;"></div>
    <div class="mini" id="playerLines" style="margin-top:6px;"></div>
    <div class="row" style="margin-top:10px;">
      <button class="btn" id="btnCopy" type="button">Copy Summary</button>
      <button class="btn" id="btnShare" type="button">Share CSV</button>
    </div>
  </section>

  <p class="small" style="margin-top:8px;">
    Scoring: 60×Save% (50 if SA=0) + Rebound (up to 20; penalizes bad rebounds even with 0 shots) + (10 − 5×Soft Goals) + min(10, 2×Big Saves). Range 0–100.
  </p>
</div>

<!-- Copy modal -->
<div class="modal" id="copyModal" role="dialog" aria-modal="true" aria-labelledby="copyTitle">
  <div class="box">
    <div id="copyTitle" class="small" style="margin-bottom:6px;">Tap inside, Select All, Copy</div>
    <textarea id="copyArea"></textarea>
    <div class="rowbtn">
      <button class="btn" id="btnCopySelect">Select All</button>
      <button class="btn undo" id="btnCopyClose">Close</button>
    </div>
  </div>
</div>

<!-- Roster modal -->
<div class="modal" id="rosterModal" role="dialog" aria-modal="true" aria-labelledby="rosterTitle">
  <div class="box">
    <div id="rosterTitle" class="small" style="margin-bottom:6px;">Roster — one number per line (persists)</div>
    <textarea id="rosterArea" placeholder="e.g.&#10;1&#10;3&#10;7&#10;9&#10;12"></textarea>
    <div class="rowbtn">
      <button class="btn" id="btnRosterSave">Save</button>
      <button class="btn undo" id="btnRosterClose">Close</button>
    </div>
  </div>
</div>

<!-- Player picker modal -->
<div class="modal" id="pickerModal" role="dialog" aria-modal="true" aria-labelledby="pickerTitle">
  <div class="box">
    <div class="inlineRow" style="justify-content:space-between;">
      <div id="pickerTitle" class="small">Select player number</div>
      <div class="small">Tap to choose • or type</div>
    </div>
    <div class="pickerGrid" id="pickerGrid"></div>
    <div class="inlineRow" style="margin-top:8px;">
      <input id="pickerInput" placeholder="Type number…" inputmode="numeric" style="flex:1;padding:10px;border-radius:10px;border:1px solid #2a3444;background:#0f1624;color:#e8ecf1">
      <button class="btn" id="pickerAdd">Use</button>
    </div>
    <div class="rowbtn" style="margin-top:8px;">
      <button class="btn" id="pickerUnknown">Unknown</button>
      <button class="btn undo" id="pickerCancel">Cancel</button>
    </div>
  </div>
</div>

<script>
  // ===== Tiny IndexedDB key-value helpers (no deps) =====
  const idbKV = (() => {
    let dbp;
    function db() {
      if (dbp) return dbp;
      dbp = new Promise((resolve, reject) => {
        const open = indexedDB.open('goalie-tracker-db', 1);
        open.onupgradeneeded = () => open.result.createObjectStore('kvs');
        open.onerror = () => reject(open.error);
        open.onsuccess = () => resolve(open.result);
      });
      return dbp;
    }
    async function get(key) {
      const d = await db();
      return new Promise((resolve, reject) => {
        const tx = d.transaction('kvs', 'readonly').objectStore('kvs').get(key);
        tx.onsuccess = () => resolve(tx.result);
        tx.onerror = () => reject(tx.error);
      });
    }
    async function set(key, val) {
      const d = await db();
      return new Promise((resolve, reject) => {
        const tx = d.transaction('kvs', 'readwrite').objectStore('kvs').put(val, key);
        tx.onsuccess = () => resolve();
        tx.onerror = () => reject(tx.error);
      });
    }
    return {get,set};
  })();

  const $ = id => document.getElementById(id);

  // ===== Stable keys (don’t version these) =====
  const SAVE_KEY   = 'goalie-tracker-state';
  const ROSTER_KEY = 'goalie-tracker-roster';

  // For auto-migration from older versions
  const OLD_KEYS = [
    'goalie-tracker-v2-8','goalie-tracker-v2-8-1','goalie-tracker-v2-8-2','goalie-tracker-v2-8-3'
  ];

  const state = {
    opponent:'', level:'U11', date:null, period:1,
    startedAt:new Date().toISOString(),
    events:[], // {type, tISO, period, player?}
    countsA:{shots:0, goals:0, softGoals:0, smothers:0, badRebounds:0, bigSaves:0},
    countsF:{shots:0, goals:0},
    roster:[]
  };

  let per = {1:initP(),2:initP(),3:initP(),4:initP()};
  function initP(){ return {A_shots:0, A_goals:0, A_smothers:0, A_badRebounds:0, A_bigSaves:0, F_shots:0, F_goals:0}; }

  // ---------- Persistence ----------
  async function persistStorage() {
    try {
      if (navigator.storage && navigator.storage.persist) {
        const granted = await navigator.storage.persist();
        if (granted) $('persistBanner').classList.remove('hidden');
      }
    } catch (_) {}
  }

  async function save() {
    try {
      const json = JSON.stringify(state);
      localStorage.setItem(SAVE_KEY, json);       // fallback
      await idbKV.set(SAVE_KEY, json);            // primary
    } catch (_) {}
  }

  async function load() {
    // 1) IDB
    try {
      const v = await idbKV.get(SAVE_KEY);
      if (v) return JSON.parse(v);
    } catch(_) {}
    // 2) localStorage
    try {
      const raw = localStorage.getItem(SAVE_KEY);
      if (raw) return JSON.parse(raw);
    } catch(_) {}
    // 3) migrate from old keys if present
    try {
      for (const k of OLD_KEYS) {
        const raw = localStorage.getItem(k);
        if (raw) {
          const parsed = JSON.parse(raw);
          // write into new keys for future runs
          await idbKV.set(SAVE_KEY, raw);
          localStorage.setItem(SAVE_KEY, raw);
          return parsed;
        }
      }
    } catch(_) {}
    return null;
  }

  function recountFromEvents(){
    state.countsA = {shots:0, goals:0, softGoals:0, smothers:0, badRebounds:0, bigSaves:0};
    state.countsF = {shots:0, goals:0};
    per = {1:initP(),2:initP(),3:initP(),4:initP()};
    for(const ev of state.events){ bump(ev.type, ev.period); }
  }

  // ---------- Helpers ----------
  function vibrate(ms=20){ if(navigator.vibrate) navigator.vibrate(ms); }
  function highlightPeriod(){
    [...$('periodChips').children].forEach(ch=>{
      const p = Number(ch.dataset.p);
      ch.classList.toggle('active', p===state.period);
      ch.setAttribute('aria-pressed', p===state.period ? 'true':'false');
    });
  }
  function fmtTime(iso){ const d=new Date(iso);
    return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
  }
  function clamp01(x){ return Math.max(0, Math.min(1, x)); }

  // ---------- Tally ----------
  function bump(type, period){
    const p = per[period] || per[4];
    if(type==='shot'){ state.countsA.shots++; p.A_shots++; }
    else if(type==='goal'){ state.countsA.shots++; state.countsA.goals++; p.A_shots++; p.A_goals++; }
    else if(type==='soft_goal'){ state.countsA.shots++; state.countsA.goals++; state.countsA.softGoals++; p.A_shots++; p.A_goals++; }
    else if(type==='smother'){ state.countsA.smothers++; p.A_smothers++; }
    else if(type==='bad_rebound'){ state.countsA.badRebounds++; p.A_badRebounds++; }
    else if(type==='big_save'){ state.countsA.bigSaves++; state.countsA.shots++; p.A_bigSaves++; p.A_shots++; }
    else if(type==='for_shot'){ state.countsF.shots++; p.F_shots++; }
    else if(type==='for_goal'){ state.countsF.shots++; state.countsF.goals++; p.F_shots++; p.F_goals++; }
  }

  // ---------- Scoring ----------
  function computeGoalieScore(){
    const C = state.countsA;
    const shots = C.shots, ga = C.goals, saves = Math.max(0, shots - ga);
    const sv    = shots>0 ? (saves/shots) : 1;

    const defensiveDen = Math.max(1, saves + ga + C.smothers);
    const badRate      = clamp01(C.badRebounds / defensiveDen);
    let scoreRebound   = 20 * (1 - badRate);
    const smotherRate  = defensiveDen>0 ? clamp01(C.smothers / defensiveDen) : 0;
    scoreRebound += Math.min(4, 4 * smotherRate);
    scoreRebound = Math.max(0, Math.min(20, scoreRebound));

    const scoreSV   = shots>0 ? 60 * sv : 50;
    const scoreSoft = Math.max(0, 10 - 5 * C.softGoals);
    const scoreBig  = Math.min(10, 2 * C.bigSaves);

    let total = Math.round(scoreSV + scoreRebound + scoreSoft + scoreBig);
    if(total<0) total=0; if(total>100) total=100;

    return {shots, ga, saves, sv, scoreSV, scoreRebound, scoreSoft, scoreBig, total,
            badRate, smotherRate};
  }

  function shotShare(){
    const sf = state.countsF.shots, sa = state.countsA.shots;
    const denom = sf + sa;
    return denom>0 ? (sf/denom) : 0.5;
  }

  // ---------- Player tallies ----------
  function perPlayerTallies(){
    const shots = new Map(); const goals = new Map(); const all=new Set();
    for(const ev of state.events){
      if(ev.type==='for_shot' && ev.player){ shots.set(ev.player,(shots.get(ev.player)||0)+1); all.add(ev.player); }
      if(ev.type==='for_goal' && ev.player){ goals.set(ev.player,(goals.get(ev.player)||0)+1); all.add(ev.player); }
    }
    const order=[...all].sort((a,b)=>{const na=+a, nb=+b; return (isNaN(na)||isNaN(nb))?(''+a).localeCompare(''+b):na-nb;});
    return {shots, goals, order};
  }

  // ---------- Render ----------
  function updateMeta(){
    $('gameMetaTag').textContent =
      `${state.opponent||'Opponent?'} • ${state.level||'U11'} • ${state.date||new Date().toISOString().slice(0,10)}`;
  }

  function refreshStats(){
    const A = state.countsA, F = state.countsF;
    const K = computeGoalieScore();
    $('shotsVal').textContent = A.shots;
    $('savesVal').textContent = K.saves;
    $('gaVal').textContent    = A.goals;
    $('svVal').textContent    = (K.sv*100).toFixed(1)+'%';
    $('smotherVal').textContent = A.smothers;
    $('brVal').textContent      = A.badRebounds;
    $('bigVal').textContent     = A.bigSaves;
    $('sfVal').textContent = F.shots;
    $('gfVal').textContent = F.goals;
    $('ssVal').textContent = ((shotShare()*100)|0) + '%';

    const phtml = [1,2,3,4].map(p=>{
      const v = per[p];
      const aSaves = Math.max(0, v.A_shots - v.A_goals);
      const aSVP = v.A_shots ? ((aSaves/v.A_shots)*100).toFixed(0)+'%' : '—';
      const title = p===4?'OT':`P${p}`;
      return `<div class="pchip"><h4>${title}</h4>
                <div>${v.F_shots}-${v.A_shots} SF-SA • ${v.F_goals}-${v.A_goals} GF-GA • SV ${aSVP}</div>
              </div>`;
    }).join('');
    $('periodSummary').innerHTML = phtml;

    const scEl = $('scoreNum');
    scEl.textContent = K.total;
    scEl.classList.remove('good','warn','bad');
    scEl.classList.add(K.total>=85?'good':K.total>=70?'warn':'bad');

    $('scoreBreakdown').innerHTML =
      `SV%: ${(K.sv*100).toFixed(1)}% → ${K.scoreSV.toFixed(1)}<br>
       Rebound: ${K.scoreRebound.toFixed(1)} (bad/def ${(K.badRate*100).toFixed(0)}%, smother ${(K.smotherRate*100).toFixed(0)}%)<br>
       Soft goals: +${K.scoreSoft.toFixed(1)}<br>
       Big saves: +${K.scoreBig.toFixed(1)}`;
  }

  function computeByPeriodLines(){
    const lines = [];
    for(const p of [1,2,3,4]){
      const v = per[p];
      const aSaves = Math.max(0, v.A_shots - v.A_goals);
      const aSV = v.A_shots ? ((aSaves/v.A_shots)*100).toFixed(0)+'%' : '—';
      lines.push(`${p===4?'OT':'P'+p}: SF-SA ${v.F_shots}-${v.A_shots}, GF-GA ${v.F_goals}-${v.A_goals}, SV ${aSV}`);
    }
    return lines.join(' | ');
  }

  function playerLinesText(){
    const T = perPlayerTallies();
    if(T.order.length===0) return 'Players: —';
    return 'Players: ' + T.order.map(n=>`#${n} ${(T.shots.get(n)||0)}S/${(T.goals.get(n)||0)}G`).join(' • ');
  }

  function summaryText(){
    const K = computeGoalieScore(), F = state.countsF, A = state.countsA;
    const title = `${state.opponent||'Opponent'} • ${state.level} • ${state.date||new Date().toISOString().slice(0,10)}`;
    return [
      `Calum — Goalie Performance Summary`,
      title,
      `Score: ${K.total}/100`,
      `Scoreline: GF-GA ${F.goals}-${A.goals} • Shots: SF-SA ${F.shots}-${A.shots} • Shot Share: ${(shotShare()*100).toFixed(0)}%`,
      computeByPeriodLines(),
      playerLinesText(),
      `Smothers: ${A.smothers} | Bad rebounds: ${A.badRebounds} | Big saves: ${A.bigSaves} | Soft goals: ${A.softGoals}`,
      `Scoring = 60×SV% (50 if SA=0) + 20×rebound control (penalizes even with 0 SA) + (10 – 5×Soft) + min(10, 2×Big)`
    ].join('\n');
  }

  function csvExport(){
    const K = computeGoalieScore(), F = state.countsF, A = state.countsA;
    const hdr = [
      'opponent','level','date','score',
      'shotsAgainst','saves','goalsAgainst','savePct',
      'smothers','badRebounds','bigSaves','softGoals',
      'shotsFor','goalsFor','shotSharePct',
      'P1_SA','P1_GA','P1_SF','P1_GF',
      'P2_SA','P2_GA','P2_SF','P2_GF',
      'P3_SA','P3_GA','P3_SF','P3_GF',
      'OT_SA','OT_GA','OT_SF','OT_GF',
      'scoreSV','scoreRebound','scoreSoft','scoreBig'
    ];
    const row = [
      JSON.stringify(state.opponent||''), JSON.stringify(state.level||''), JSON.stringify(state.date||new Date().toISOString().slice(0,10)),
      K.total, A.shots, K.saves, A.goals, (K.sv*100).toFixed(1),
      A.smothers, A.badRebounds, A.bigSaves, A.softGoals,
      F.shots, F.goals, (shotShare()*100).toFixed(0),
      per[1].A_shots, per[1].A_goals, per[1].F_shots, per[1].F_goals,
      per[2].A_shots, per[2].A_goals, per[2].F_shots, per[2].F_goals,
      per[3].A_shots, per[3].A_goals, per[3].F_shots, per[3].F_goals,
      per[4].A_shots, per[4].A_goals, per[4].F_shots, per[4].F_goals,
      K.scoreSV.toFixed(1), K.scoreRebound.toFixed(1), K.scoreSoft.toFixed(1), K.scoreBig.toFixed(1)
    ].join(',');
    const lines = [hdr.join(','), row, '', 'period,time,event,player'];
    state.events.forEach(ev=>{
      const label = ev.type.replace('soft_goal','soft goal').replace('bad_rebound','bad rebound')
                           .replace('for_shot','our shot').replace('for_goal','our goal');
      const player = ev.player ? `#${ev.player}` : '';
      lines.push(`${ev.period},${fmtTime(ev.tISO)},${label},${player}`);
    });
    const T = perPlayerTallies();
    lines.push('', 'player,shotsFor,goalsFor');
    for(const n of T.order){ lines.push(`${n},${T.shots.get(n)||0},${T.goals.get(n)||0}`); }
    return lines.join('\n');
  }

  function refreshLog(){
    $('log').innerHTML = state.events.slice(-200).map(ev=>{
      let label = ev.type.replace('soft_goal','Soft Goal').replace('bad_rebound','Bad Rebound')
                         .replace('for_shot','Our Shot').replace('for_goal','Our Goal').replace('_',' ');
      if(ev.player) label += ` (#${ev.player})`;
      return `<div class="item">P${ev.period} • ${fmtTime(ev.tISO)} — ${label}</div>`;
    }).join('');
    $('log').scrollTop = $('log').scrollHeight;
  }

  function renderAll(){ highlightPeriod(); updateMeta(); refreshStats(); refreshLog(); $('summaryPanel').classList.add('hidden'); }

  // ---------- Writers ----------
  function addEvent(type, meta={}){
    const ev = {type, tISO:new Date().toISOString(), period:state.period, ...meta};
    state.events.push(ev); bump(type, state.period); save(); renderAll(); vibrate();
  }
  function undo(){
    const ev = state.events.pop(); if(!ev) return;
    const p = per[ev.period] || per[4];
    if(ev.type==='shot'){ state.countsA.shots--; p.A_shots--; }
    else if(ev.type==='goal'){ state.countsA.shots--; state.countsA.goals--; p.A_shots--; p.A_goals--; }
    else if(ev.type==='soft_goal'){ state.countsA.shots--; state.countsA.goals--; state.countsA.softGoals--; p.A_shots--; p.A_goals--; }
    else if(ev.type==='smother'){ state.countsA.smothers--; p.A_smothers--; }
    else if(ev.type==='bad_rebound'){ state.countsA.badRebounds--; p.A_badRebounds--; }
    else if(ev.type==='big_save'){ state.countsA.bigSaves--; state.countsA.shots--; p.A_bigSaves--; p.A_shots--; }
    else if(ev.type==='for_shot'){ state.countsF.shots--; p.F_shots--; }
    else if(ev.type==='for_goal'){ state.countsF.shots--; state.countsF.goals--; p.F_shots--; p.F_goals--; }
    save(); renderAll(); vibrate(15);
  }
  function nextPeriod(){ state.period = Math.min(4, state.period+1); highlightPeriod(); save(); vibrate(10); }

  // ---------- Player Picker ----------
  let pendingType=null;
  function openPicker(type){ pendingType=type; buildPickerGrid(); $('pickerInput').value=''; $('pickerModal').style.display='flex'; }
  function closePicker(){ $('pickerModal').style.display='none'; pendingType=null; }
  function buildPickerGrid(){
    const grid = $('pickerGrid'), roster = (state.roster||[]);
    const uniq = Array.from(new Set(roster.map(x=>String(x).trim()).filter(Boolean)));
    uniq.sort((a,b)=>{const na=+a, nb=+b; return (isNaN(na)||isNaN(nb))?(''+a).localeCompare(''+b):na-nb;});
    grid.innerHTML = uniq.length? uniq.map(n=>`<div class="pickerBtn" data-n="${n}">#${n}</div>`).join('')
                                : `<div class="small">No roster yet. Add numbers in the Roster menu.</div>`;
  }
  $('pickerGrid').addEventListener('click', e=>{
    const b=e.target.closest('.pickerBtn'); if(!b||!pendingType) return;
    addEvent(pendingType,{player:b.dataset.n}); closePicker();
  });
  $('pickerAdd').addEventListener('click', ()=>{
    if(!pendingType) return;
    const v=$('pickerInput').value.trim(); if(!v) return;
    addEvent(pendingType,{player:v});
    if(!state.roster.includes(v)){ state.roster.push(v); localStorage.setItem(ROSTER_KEY, JSON.stringify(state.roster)); save(); }
    closePicker();
  });
  $('pickerUnknown').addEventListener('click', ()=>{ if(pendingType){ addEvent(pendingType,{player:'?'}); closePicker(); }});
  $('pickerCancel').addEventListener('click', closePicker);

  // ---------- Roster editor ----------
  function openRoster(){ $('rosterArea').value=(state.roster||[]).join('\n'); $('rosterModal').style.display='flex'; }
  function closeRoster(){ $('rosterModal').style.display='none'; }
  function saveRosterFromArea(){
    const lines=$('rosterArea').value.split('\n').map(s=>s.trim()).filter(Boolean);
    state.roster=Array.from(new Set(lines));
    localStorage.setItem(ROSTER_KEY, JSON.stringify(state.roster));
    save();
    closeRoster();
  }

  // ---------- Summary / Controls ----------
  function endGame(){
    $('summaryPanel').classList.remove('hidden');
    $('byPeriodLines').textContent = computeByPeriodLines();
    $('playerLines').textContent = playerLinesText();
    window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
  }
  function newGame(){
    if(confirm('Start a new game? This will clear the current log.')){
      state.opponent=''; state.level='U11'; state.date=null; state.period=1;
      state.startedAt=new Date().toISOString();
      state.events=[]; state.countsA={shots:0, goals:0, softGoals:0, smothers:0, badRebounds:0, bigSaves:0};
      state.countsF={shots:0, goals:0}; per = {1:initP(),2:initP(),3:initP(),4:initP()};
      save(); renderAll();
    }
  }

  // ---------- Copy / Share / Backup / Restore ----------
  function openCopyModal(text){ $('copyArea').value=text; $('copyModal').style.display='flex'; setTimeout(()=>{$('copyArea').focus(); $('copyArea').select(); }, 50); }
  $('btnCopy').addEventListener('click', async ()=>{
    const text = summaryText();
    try{ if(navigator.clipboard && location.protocol!=='data:'){ await navigator.clipboard.writeText(text); alert('Summary copied.'); }
      else{ const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('Summary copied.'); }
    }catch(e){ openCopyModal(text); }
  });
  $('btnCopySelect').addEventListener('click', ()=>{ $('copyArea').focus(); $('copyArea').select(); });
  $('btnCopyClose').addEventListener('click', ()=>{ $('copyModal').style.display='none'; });
  $('btnShare').addEventListener('click', ()=>{ const url='data:text/csv;charset=utf-8,'+encodeURIComponent(csvExport()); window.open(url,'_blank'); });

  $('btnBackup').addEventListener('click', ()=>{
    const json=JSON.stringify(state,null,2);
    try{ const blob=new Blob([json],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='goalie_state.json'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),1200);
    }catch(e){ openCopyModal(json); }
  });
  $('btnRestore').addEventListener('click', async ()=>{
    const txt=prompt('Paste backup JSON here:'); if(!txt) return;
    try{ const s=JSON.parse(txt); if(!Array.isArray(s.events)) throw 0; Object.assign(state,s); recountFromEvents(); await save(); renderAll(); alert('Restore complete.'); }
    catch(e){ alert('Invalid JSON.'); }
  });

  // ---------- Wiring ----------
  $('btnShot').addEventListener('click', ()=>addEvent('shot'));
  $('btnBigSave').addEventListener('click', ()=>addEvent('big_save'));
  $('btnGoal').addEventListener('click', ()=>addEvent('goal'));
  $('btnSoftGoal').addEventListener('click', ()=>addEvent('soft_goal'));
  $('btnSmother').addEventListener('click', ()=>addEvent('smother'));
  $('btnBadRebound').addEventListener('click', ()=>addEvent('bad_rebound'));
  $('btnForShot').addEventListener('click', ()=>openPicker('for_shot'));
  $('btnForGoal').addEventListener('click', ()=>openPicker('for_goal'));
  $('btnUndo').addEventListener('click', undo);
  $('btnNextPeriod').addEventListener('click', nextPeriod);
  $('btnEnd').addEventListener('click', endGame);
  $('btnReset').addEventListener('click', newGame);

  $('btnRoster').addEventListener('click', openRoster);
  $('btnRosterSave').addEventListener('click', saveRosterFromArea);
  $('btnRosterClose').addEventListener('click', closeRoster);

  $('opponent').addEventListener('input', e=>{ state.opponent=e.target.value; save(); updateMeta(); });
  $('level').addEventListener('change',  e=>{ state.level=e.target.value; save(); updateMeta(); });
  $('date').addEventListener('change',   e=>{ state.date=e.target.value;  save(); updateMeta(); });
  $('periodChips').addEventListener('click', e=>{ const chip=e.target.closest('.chip'); if(!chip) return; state.period=Number(chip.dataset.p); highlightPeriod(); save(); });

  // Extra safety nets
  window.addEventListener('pagehide', save);
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState!=='visible') save(); });
  setInterval(save, 5000); // periodic autosave

  // ---------- Init ----------
  (async function init(){
    $('date').valueAsDate = new Date();
    await persistStorage();

    // Load roster
    try{
      const r = localStorage.getItem(ROSTER_KEY);
      state.roster = r ? JSON.parse(r) : [];
    }catch(_){ state.roster=[]; }

    // Load state (IDB > LS > migrate)
    const loaded = await load();
    if (loaded && Array.isArray(loaded.events)) {
      Object.assign(state, loaded);
      recountFromEvents();
      $('resumeBanner').classList.remove('hidden');
    }

    updateMeta(); renderAll();
  })();
</script>
</body>
</html>
