<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>Team Tracker – iPhone (v3.3.2)</title>
<style>
  :root{
    --bg:#0b0e11; --panel:#141922; --ink:#e8ecf1; --muted:#9aa6b2; --accent:#4da3ff;
    --good:#35c759; --warn:#ff9f0a; --bad:#ff453a; --btn:#1f2a38; --btn2:#243041; --radius:14px;
  }
  html,body{height:100%}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  .wrap{max-width:520px;margin:0 auto;padding:14px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:6px 0 10px}
  header h1{font-size:20px;margin:0;letter-spacing:.2px}
  .tag{font-size:12px;color:var(--muted)}
  .panel{background:var(--panel);border-radius:var(--radius);padding:12px;box-shadow:0 6px 18px rgba(0,0,0,.25)}
  .row{display:flex;gap:10px}.col{flex:1}
  label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
  input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #2a3444;background:var(--btn);color:var(--ink);font-size:14px;outline:none}

  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
  .btn{-webkit-tap-highlight-color:transparent;background:var(--btn2);color:var(--ink);border:none;padding:16px 14px;border-radius:14px;font-size:16px;font-weight:600;box-shadow:0 6px 12px rgba(0,0,0,.22);touch-action:manipulation;user-select:none;cursor:pointer}
  .btn:active{transform:scale(.98)}
  .btn.shot{background:#1e2f47}.btn.goal{background:#3a2230}.btn.soft{background:#4b2430}.btn.smother{background:#1d3b2a}
  .btn.bad{background:#3b2a1d}.btn.big{background:#1d2f3b}.btn.undo{background:#2b3240}.btn.period{background:#2a2f3a}
  .btn.end{background:linear-gradient(180deg,#345e2f,#1f381c)}
  .btn.roster{background:#20324a;padding:10px 12px;font-size:14px}
  .btn.team{background:#2a2342}
  .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:12px}
  .card{background:#101520;border:1px solid #233044;border-radius:12px;padding:10px}
  .card h3{margin:0 0 2px;font-size:12px;color:var(--muted)} .card .val{font-size:18px;font-weight:700}
  .periods{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin-top:4px}
  .chip{text-align:center;padding:10px 8px;border-radius:10px;border:1px solid #2a3444;background:#152030;font-weight:700;cursor:pointer;user-select:none}
  .chip.active{background:#1b3352;border-color:#2f5e9a;color:#cfe5ff}

  .log{margin-top:10px;max-height:180px;overflow:auto;border:1px solid #233044;border-radius:12px;padding:8px;background:#0f141d}
  .log .item{font-size:13px;padding:6px 4px;border-bottom:1px dashed #202b3b}.log .item:last-child{border-bottom:none}
  .foot-actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .small{font-size:12px;color:var(--muted)}
  .score{font-size:44px;font-weight:800;letter-spacing:1px}
  .good{color:var(--good)}.warn{color:var(--warn)}.bad{color:var(--bad)}
  .hidden{display:none}
  .banner{margin-top:8px;padding:8px 10px;border-radius:10px;background:#0e1a2a;border:1px solid #224064;color:#cfe5ff;font-size:12px}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
  .modal .box{background:#0e1320;border:1px solid #2a3a55;border-radius:12px;max-width:520px;width:100%;padding:12px}
  .modal textarea{width:100%;height:220px;background:#0b1220;color:#e8ecf1;border:1px solid #243248;border-radius:10px;padding:8px;font-size:14px}
  .modal .rowbtn{display:flex;gap:10px;margin-top:8px}
  .mini{font-size:11px;color:#a6b3c2}
  .pgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
  .pchip{background:#0f1a28;border:1px solid #223045;border-radius:10px;padding:8px}
  .pchip h4{margin:0 0 4px;font-size:11px;color:#9ab7d6}
  .pchip div{font-size:13px;font-weight:700}
  .pickerGrid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px}
  .pickerBtn{background:#152033;border:1px solid #2a3c5a;border-radius:10px;padding:12px 8px;text-align:center;font-weight:800;cursor:pointer}
  .inlineRow{display:flex;gap:8px;align-items:center}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #233044;padding:6px 8px;font-size:12px}
  th{background:#0f1a28;color:#cfe5ff;text-align:left}
  .undoList{max-height:300px;overflow:auto;margin-top:6px}
  .undoRow{background:#10182a;border:1px solid #22324a;border-radius:10px;padding:10px;margin-bottom:8px;cursor:pointer}
  .undoRow:active{transform:scale(.99)}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#0f1e32;border:1px solid #274468;color:#d9ecff;padding:10px 12px;border-radius:12px;font-size:13px;display:none;z-index:10000}
  .toast button{margin-left:8px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Team Tracker</h1>
    <div class="inlineRow">
      <button class="btn roster" id="btnRoster" type="button" aria-haspopup="dialog" aria-controls="rosterModal">Roster</button>
      <div class="tag" id="gameMetaTag">New game</div>
    </div>
  </header>

  <!-- Setup panel omitted here for brevity — unchanged from v3.3.1 -->

  <!-- ACTION BUTTONS / STATS / LOG / FOOTER PANELS — unchanged layout -->

  <!-- ... everything above this comment remains exactly the same as v3.3.1 ... -->

<script>
/* service worker registration unchanged */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', ()=>navigator.serviceWorker.register('service-worker.js'));
}

/* constants, idb helper, state, persistence, helpers — unchanged from v3.3.1 */

/* ===== NEW: display helpers for raw save% (.xxx) ===== */
function formatRawSV(saves, SA){
  // hockey-style: ".xxx" with three decimals; if no shots, show ".000"
  if (SA <= 0) return '.000';
  const v = saves / SA;
  // toFixed(3) returns "0.xxx"; we slice off leading zero
  return (v.toFixed(3)).slice(1);
}

/* everything else (events, undo, GA context) unchanged from v3.3.1 */

/* ===== Scoring functions (same as v3.3.1) ===== */
/* ... computeGoalieScore() and computeTeamScore() identical to previous version ... */

/* ===== Renders — updated to show raw SV as .xxx ===== */

function refreshStats(){
  const A = state.countsA, F = state.countsF, T = state.team;
  const K = computeGoalieScore();
  const Team = computeTeamScore();

  const saves = Math.max(0, A.shots - A.goals);
  $('shotsVal').textContent = A.shots;
  $('savesVal').textContent = saves;
  $('gaVal').textContent    = A.goals;
  $('svVal').textContent    = formatRawSV(saves, A.shots);   // <<< raw .xxx
  $('smotherVal').textContent = A.smothers;
  $('brVal').textContent      = A.badRebounds;
  $('bigVal').textContent     = A.bigSaves;
  $('sfVal').textContent      = F.shots;
  $('gfVal').textContent      = F.goals;
  $('shootVal').textContent   = F.shots>0 ? ((F.goals/F.shots).toFixed(3)).slice(1) : '.000'; // show our Sh% as .xxx
  $('ssVal').textContent      = (state.countsF.shots+state.countsA.shots>0 ? ((state.countsF.shots/(state.countsF.shots+state.countsA.shots)).toFixed(3)).slice(1) : '.500');
  $('baVal').textContent      = T.breakawaysAgainst||0;
  $('dzVal').textContent      = T.dzTurnovers||0;
  $('teamScoreVal').textContent = Team.total;

  const phtml = [1,2,3,4].map(p=>{
    const v = per[p];
    const pSaves = Math.max(0, v.A_shots - v.A_goals);
    const svp = formatRawSV(pSaves, v.A_shots);
    const ourShp = v.F_shots? ((v.F_goals/v.F_shots).toFixed(3)).slice(1):'.000';
    const title = p===4?'OT':`P${p}`;
    return `<div class="pchip"><h4>${title}</h4>
              <div>SF-SA ${v.F_shots}-${v.A_shots} • GF-GA ${v.F_goals}-${v.A_goals} • SV ${svp} • Sh% ${ourShp}</div>
            </div>`;
  }).join('');
  $('periodSummary').innerHTML = phtml;

  const gsEl = $('goalieScoreNum'), tsEl = $('teamScoreNum');
  if (gsEl && tsEl) {
    gsEl.textContent = K.total; tsEl.textContent = Team.total;
    [gsEl, tsEl].forEach(el => { el.classList.remove('good','warn','bad'); });
    gsEl.classList.add(K.total>=85?'good':K.total>=70?'warn':'bad');
    tsEl.classList.add(Team.total>=85?'good':Team.total>=70?'warn':'bad');
  }
}

function makeSummaryTable(){
  const rows = [];
  const header = `<table><thead><tr>
    <th>Period</th><th>Shots For</th><th>Shots Against</th><th>Goals For</th><th>Goals Against</th><th>Save %</th><th>Our Sh%</th>
  </tr></thead><tbody>`;
  for(const p of [1,2,3,4]){
    const v = per[p];
    const pSaves = Math.max(0, v.A_shots - v.A_goals);
    const svp = formatRawSV(pSaves, v.A_shots);
    const ourShp = v.F_shots? ((v.F_goals/v.F_shots).toFixed(3)).slice(1):'.000';
    const title = p===4?'OT':p;
    rows.push(`<tr><td>${title}</td><td>${v.F_shots}</td><td>${v.A_shots}</td><td>${v.F_goals}</td><td>${v.A_goals}</td><td>${svp}</td><td>${ourShp}</td></tr>`);
  }
  const F = state.countsF, A = state.countsA;
  const totalSaves = Math.max(0, A.shots - A.goals);
  const totalSVP = formatRawSV(totalSaves, A.shots);
  const ourShpT = F.shots? ((F.goals/F.shots).toFixed(3)).slice(1):'.000';
  rows.push(`<tr><th>Total</th><th>${F.shots}</th><th>${A.shots}</th><th>${F.goals}</th><th>${A.goals}</th><th>${totalSVP}</th><th>${ourShpT}</th></tr>`);
  const tbl = header + rows.join('') + `</tbody></table>`;

  const T = perPlayerTallies();
  const playerRows = T.order.map(n=>{
    const s=T.shots.get(n)||0, g=T.goals.get(n)||0, a=T.assists.get(n)||0;
    const shp = s? ((g/s).toFixed(3)).slice(1):'.000';
    return `<tr><td>#${n}</td><td>${s}</td><td>${g}</td><td>${a}</td><td>${shp}</td></tr>`;
  }).join('');
  const playersTbl = `
    <div class="card" style="margin-top:10px;">
      <h3>Players</h3>
      <table style="margin-top:6px;">
        <thead><tr><th>Player</th><th>Shots</th><th>Goals</th><th>Assists</th><th>Sh%</th></tr></thead>
        <tbody>${playerRows||'<tr><td colspan="5">—</td></tr>'}</tbody>
      </table>
    </div>`;
  return tbl + playersTbl;
}

function buildReadableSummary(){
  const K = computeGoalieScore(), Team = computeTeamScore();
  const F=state.countsF, A=state.countsA;
  const date = state.date || new Date().toISOString().slice(0,10);
  const opponent = state.opponent || 'Unknown opponent';
  const level = state.level || 'U11';
  const gaBA = state.events.filter(e=> (e.type==='goal'||e.type==='soft_goal') && e.ga_cause==='BA').length;
  const gaDZ = state.events.filter(e=> (e.type==='goal'||e.type==='soft_goal') && e.ga_cause==='DZ').length;
  const gaOther = state.events.filter(e=> (e.type==='goal'||e.type==='soft_goal') && (!e.ga_cause || e.ga_cause==='other')).length;
  const ourShPct = F.shots? ((F.goals/F.shots).toFixed(3)).slice(1) : '.000';
  const rawSV = formatRawSV(Math.max(0, A.shots - A.goals), A.shots);

  return `
  <div class="card">
    <h3>Game Info</h3>
    <div><b>Date:</b> ${date}</div>
    <div><b>Opponent:</b> ${opponent} (${level})</div>
  </div>

  <div class="card" style="margin-top:8px;">
    <h3>Scores</h3>
    <div><b>Team Score:</b> ${Team.total} / 100</div>
    <div><b>Goalie Score:</b> ${K.total} / 100</div>
  </div>

  <div class="card" style="margin-top:8px;">
    <h3>Team Stats</h3>
    <div>Shots For: <b>${F.shots}</b> | Goals For: <b>${F.goals}</b> | Shooting %: <b>${ourShPct}</b></div>
    <div>Shots Against: <b>${A.shots}</b> | Goals Against: <b>${A.goals}</b> | Save %: <b>${rawSV}</b></div>
    <div>Goals Against off Breakaway: <b>${gaBA}</b> | off D-zone Turnover: <b>${gaDZ}</b> | Other: <b>${gaOther}</b></div>
  </div>
  `;
}

/* the rest of the file (exports, roster/picker, wiring, init) stays the same as v3.3.1 */
</script>
</body>
</html>
