<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Team Tracker – iPhone (v3.1.0)</title>
<style>
  :root{
    --bg:#0b0e11; --panel:#141922; --ink:#e8ecf1; --muted:#9aa6b2; --accent:#4da3ff;
    --good:#35c759; --warn:#ff9f0a; --bad:#ff453a; --btn:#1f2a38; --btn2:#243041; --radius:14px;
  }
  html,body{height:100%}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  .wrap{max-width:520px;margin:0 auto;padding:14px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:6px 0 10px}
  header h1{font-size:20px;margin:0;letter-spacing:.2px}
  .tag{font-size:12px;color:var(--muted)}
  .panel{background:var(--panel);border-radius:var(--radius);padding:12px;box-shadow:0 6px 18px rgba(0,0,0,.25)}
  .row{display:flex;gap:10px}.col{flex:1}
  label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
  input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #2a3444;background:var(--btn);color:var(--ink);font-size:14px;outline:none}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
  .btn{-webkit-tap-highlight-color:transparent;background:var(--btn2);color:var(--ink);border:none;padding:16px 14px;border-radius:14px;font-size:16px;font-weight:600;box-shadow:0 6px 12px rgba(0,0,0,.22);touch-action:manipulation;user-select:none;cursor:pointer}
  .btn:active{transform:scale(.98)}
  .btn.shot{background:#1e2f47}.btn.goal{background:#3a2230}.btn.soft{background:#4b2430}.btn.smother{background:#1d3b2a}
  .btn.bad{background:#3b2a1d}.btn.big{background:#1d2f3b}.btn.undo{background:#2b3240}.btn.period{background:#2a2f3a}
  .btn.end{background:linear-gradient(180deg,#345e2f,#1f381c)}
  .btn.roster{background:#20324a;padding:10px 12px;font-size:14px}
  .btn.team{background:#2a2342}
  .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:12px}
  .card{background:#101520;border:1px solid #233044;border-radius:12px;padding:10px}
  .card h3{margin:0 0 2px;font-size:12px;color:var(--muted)} .card .val{font-size:18px;font-weight:700}
  .periods{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin-top:4px}
  .chip{text-align:center;padding:10px 8px;border-radius:10px;border:1px solid #2a3444;background:#152030;font-weight:700;cursor:pointer;user-select:none}
  .chip.active{background:#1b3352;border-color:#2f5e9a;color:#cfe5ff}
  .log{margin-top:10px;max-height:180px;overflow:auto;border:1px solid #233044;border-radius:12px;padding:8px;background:#0f141d}
  .log .item{font-size:13px;padding:6px 4px;border-bottom:1px dashed #202b3b}.log .item:last-child{border-bottom:none}
  .foot-actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .small{font-size:12px;color:var(--muted)}
  .score{font-size:44px;font-weight:800;letter-spacing:1px}
  .good{color:var(--good)}.warn{color:var(--warn)}.bad{color:var(--bad)}
  .hidden{display:none}
  .banner{margin-top:8px;padding:8px 10px;border-radius:10px;background:#0e1a2a;border:1px solid #224064;color:#cfe5ff;font-size:12px}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
  .modal .box{background:#0e1320;border:1px solid #2a3a55;border-radius:12px;max-width:520px;width:100%;padding:12px}
  .modal textarea{width:100%;height:220px;background:#0b1220;color:#e8ecf1;border:1px solid #243248;border-radius:10px;padding:8px;font-size:14px}
  .modal .rowbtn{display:flex;gap:10px;margin-top:8px}
  .mini{font-size:11px;color:#a6b3c2}
  .pgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
  .pchip{background:#0f1a28;border:1px solid #223045;border-radius:10px;padding:8px}
  .pchip h4{margin:0 0 4px;font-size:11px;color:#9ab7d6}
  .pchip div{font-size:13px;font-weight:700}
  .pickerGrid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px}
  .pickerBtn{background:#152033;border:1px solid #2a3c5a;border-radius:10px;padding:12px 8px;text-align:center;font-weight:800;cursor:pointer}
  .inlineRow{display:flex;gap:8px;align-items:center}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #233044;padding:6px 8px;font-size:12px}
  th{background:#0f1a28;color:#cfe5ff;text-align:left}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Team Tracker</h1>
    <div class="inlineRow">
      <button class="btn roster" id="btnRoster" type="button" aria-haspopup="dialog" aria-controls="rosterModal">Roster</button>
      <div class="tag" id="gameMetaTag">New game</div>
    </div>
  </header>

  <section class="panel" id="setupPanel">
    <div class="row">
      <div class="col"><label for="opponent">Opponent</label><input id="opponent" placeholder="e.g., Napanee Stars" autocomplete="off"></div>
      <div class="col"><label for="level">Level</label>
        <select id="level"><option>U9</option><option selected>U11</option><option>U13</option><option>U15</option><option>U18</option><option>Other</option></select>
      </div>
    </div>
    <div class="row" style="margin-top:8px;">
      <div class="col"><label for="date">Date</label><input id="date" type="date"></div>
      <div class="col">
        <label>Current Period</label>
        <div class="periods" id="periodChips">
          <div class="chip active" data-p="1" role="button" aria-pressed="true">1</div>
          <div class="chip" data-p="2" role="button" aria-pressed="false">2</div>
          <div class="chip" data-p="3" role="button" aria-pressed="false">3</div>
          <div class="chip" data-p="4" role="button" aria-pressed="false">OT</div>
        </div>
      </div>
    </div>
    <div class="small">Row 1 = saves, Row 2 = goals, Row 3 = rebounds, Row 4 = our offense (w/ player picker), Row 5 = team misc, bottom = controls.</div>
    <div id="resumeBanner" class="banner hidden">Resumed saved game.</div>
    <div id="persistBanner" class="banner hidden">Storage locked in. Your game will resume even after long pauses.</div>
  </section>

  <section class="panel" style="margin-top:12px;">
    <div class="grid">
      <!-- Row 1 -->
      <button class="btn shot" id="btnShot" type="button">Shot (Saved)</button>
      <button class="btn big" id="btnBigSave" type="button">Big Save</button>
      <!-- Row 2 -->
      <button class="btn goal" id="btnGoal" type="button">Goal</button>
      <button class="btn soft" id="btnSoftGoal" type="button">Soft Goal</button>
      <!-- Row 3 -->
      <button class="btn smother" id="btnSmother" type="button">Smother</button>
      <button class="btn bad" id="btnBadRebound" type="button">Bad Rebound</button>
      <!-- Row 4 -->
      <button class="btn" id="btnForShot" type="button">Our Shot</button>
      <button class="btn" id="btnForGoal" type="button">Our Goal</button>
      <!-- Row 5 (team misc) -->
      <button class="btn team" id="btnBreakaway" type="button">Breakaway Against</button>
      <button class="btn team" id="btnDZTurnover" type="button">D-Zone Turnover</button>
      <!-- Row 6 -->
      <button class="btn undo" id="btnUndo" type="button">Undo</button>
      <button class="btn period" id="btnNextPeriod" type="button">Next Period</button>
    </div>

    <div class="stats" id="stats">
      <div class="card"><h3>Shots Against</h3><div class="val" id="shotsVal">0</div></div>
      <div class="card"><h3>Saves</h3><div class="val" id="savesVal">0</div></div>
      <div class="card"><h3>Goals Against</h3><div class="val" id="gaVal">0</div></div>
      <div class="card"><h3>Save %</h3><div class="val" id="svVal">—</div></div>
      <div class="card"><h3>Smothers</h3><div class="val" id="smotherVal">0</div></div>
      <div class="card"><h3>Bad Rebounds</h3><div class="val" id="brVal">0</div></div>
      <div class="card"><h3>Big Saves</h3><div class="val" id="bigVal">0</div></div>
      <div class="card"><h3>Shots For</h3><div class="val" id="sfVal">0</div></div>
      <div class="card"><h3>Goals For</h3><div class="val" id="gfVal">0</div></div>
      <div class="card"><h3>Our Shooting %</h3><div class="val" id="shootVal">—</div></div>
      <div class="card"><h3>Shot Share</h3><div class="val" id="ssVal">—</div></div>
      <div class="card"><h3>Breakaways Ag.</h3><div class="val" id="baVal">0</div></div>
      <div class="card"><h3>D-Zone TO</h3><div class="val" id="dzVal">0</div></div>
      <div class="card"><h3>Team Score</h3><div class="val" id="teamScoreVal">—</div></div>
    </div>

    <div class="pgrid" id="periodSummary"></div>
    <div class="log" id="log"></div>

    <div class="foot-actions">
      <button class="btn end" id="btnEnd" type="button">End Game & Score</button>
      <button class="btn undo" id="btnReset" type="button">New Game</button>
    </div>

    <div class="row" style="margin-top:10px;">
      <button class="btn" id="btnExportGameCSV" type="button">Export Game CSV</button>
      <button class="btn" id="btnExportSeasonCSV" type="button">Export Season Log</button>
    </div>
  </section>

  <!-- Summary panel -->
  <section class="panel hidden" id="summaryPanel" style="margin-top:12px;">
    <div style="display:flex;gap:12px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;">
      <div>
        <div class="small" id="summaryTitle">Game Summary</div>
        <div style="display:flex; gap:16px; align-items:flex-end;">
          <div>
            <div class="small">Goalie Score</div>
            <div id="goalieScoreNum" class="score">—</div>
          </div>
          <div>
            <div class="small">Team Score</div>
            <div id="teamScoreNum" class="score">—</div>
          </div>
        </div>
      </div>
      <div class="card" style="min-width:220px;">
        <h3>Goalie Breakdown</h3>
        <div class="small" id="scoreBreakdown"></div>
      </div>
    </div>

    <div id="summaryTableWrap" style="margin-top:8px;"></div>
    <div class="mini" id="playerLines" style="margin-top:6px;"></div>
    <div class="mini" id="teamExtras" style="margin-top:6px;"></div>
  </section>
</div>

<!-- Copy modal -->
<div class="modal" id="copyModal" role="dialog" aria-modal="true" aria-labelledby="copyTitle">
  <div class="box">
    <div id="copyTitle" class="small" style="margin-bottom:6px;">CSV preview — Tap inside, Select All, Copy</div>
    <textarea id="copyArea"></textarea>
    <div class="rowbtn">
      <button class="btn" id="btnCopySelect">Select All</button>
      <button class="btn undo" id="btnCopyClose">Close</button>
    </div>
  </div>
</div>

<!-- Roster modal -->
<div class="modal" id="rosterModal" role="dialog" aria-modal="true" aria-labelledby="rosterTitle">
  <div class="box">
    <div id="rosterTitle" class="small" style="margin-bottom:6px;">Roster — one number per line (persists)</div>
    <textarea id="rosterArea" placeholder="e.g.&#10;1&#10;3&#10;7&#10;9&#10;12"></textarea>
    <div class="rowbtn">
      <button class="btn" id="btnRosterSave">Save</button>
      <button class="btn undo" id="btnRosterClose">Close</button>
    </div>
  </div>
</div>

<!-- Player picker modal -->
<div class="modal" id="pickerModal" role="dialog" aria-modal="true" aria-labelledby="pickerTitle">
  <div class="box">
    <div class="inlineRow" style="justify-content:space-between;">
      <div id="pickerTitle" class="small">Select player number</div>
      <div class="small">Tap to choose • or type</div>
    </div>
    <div class="pickerGrid" id="pickerGrid"></div>
    <div class="inlineRow" style="margin-top:8px;">
      <input id="pickerInput" placeholder="Type number…" inputmode="numeric" style="flex:1;padding:10px;border-radius:10px;border:1px solid #2a3444;background:#0f1624;color:#e8ecf1">
      <button class="btn" id="pickerAdd">Use</button>
    </div>
    <div class="rowbtn" style="margin-top:8px;">
      <button class="btn" id="pickerUnknown">Unknown</button>
      <button class="btn undo" id="pickerCancel">Cancel</button>
    </div>
  </div>
</div>

<script>
  /* ===== IndexedDB KV helper ===== */
  const idbKV = (() => {
    let dbp;
    function db(){
      if (dbp) return dbp;
      dbp = new Promise((resolve,reject)=>{
        const open = indexedDB.open('team-tracker-db',1);
        open.onupgradeneeded = () => open.result.createObjectStore('kvs');
        open.onerror = () => reject(open.error);
        open.onsuccess = () => resolve(open.result);
      });
      return dbp;
    }
    async function get(key){
      const d = await db();
      return new Promise((res,rej)=>{
        const r = d.transaction('kvs','readonly').objectStore('kvs').get(key);
        r.onsuccess = () => res(r.result);
        r.onerror = () => rej(r.error);
      });
    }
    async function set(key,val){
      const d = await db();
      return new Promise((res,rej)=>{
        const w = d.transaction('kvs','readwrite').objectStore('kvs').put(val,key);
        w.onsuccess = () => res();
        w.onerror = () => rej(w.error);
      });
    }
    return {get,set};
  })();

  const $ = id => document.getElementById(id);

  /* ===== Keys ===== */
  const SAVE_KEY = 'team-tracker-state';
  const ROSTER_KEY = 'team-tracker-roster';
  const SEASON_KEY = 'team-tracker-season';
  const OLD_KEYS = ['goalie-tracker-state','goalie-tracker-v2-8','goalie-tracker-v2-8-3'];

  /* ===== State ===== */
  const state = {
    opponent:'', level:'U11', date:null, period:1,
    startedAt:new Date().toISOString(), gameId:Math.random().toString(36).slice(2),
    events:[], // {type, tISO, period, player?, assist?}
    countsA:{shots:0, goals:0, softGoals:0, smothers:0, badRebounds:0, bigSaves:0},
    countsF:{shots:0, goals:0},
    team:{breakawaysAgainst:0, dzTurnovers:0},
    roster:[]
  };
  let per = {1:initP(),2:initP(),3:initP(),4:initP()};
  function initP(){ return {A_shots:0, A_goals:0, A_smothers:0, A_badRebounds:0, A_bigSaves:0, F_shots:0, F_goals:0, BA:0, DZ:0}; }

  /* ===== Persistence ===== */
  async function persistStorage(){ try{ if(navigator.storage && navigator.storage.persist){ const ok=await navigator.storage.persist(); if(ok) $('persistBanner').classList.remove('hidden'); } }catch(_){} }
  async function save(){
    try{
      const json = JSON.stringify(state);
      localStorage.setItem(SAVE_KEY,json);
      await idbKV.set(SAVE_KEY,json);
    }catch(_){}
  }
  async function load(){
    try{ const v=await idbKV.get(SAVE_KEY); if(v) return JSON.parse(v); }catch(_){}
    try{ const v=localStorage.getItem(SAVE_KEY); if(v) return JSON.parse(v); }catch(_){}
    for(const k of OLD_KEYS){ try{ const v=localStorage.getItem(k); if(v){ await idbKV.set(SAVE_KEY,v); localStorage.setItem(SAVE_KEY,v); return JSON.parse(v); } }catch(_){} }
    return null;
  }
  async function loadSeason(){
    try{ const v=await idbKV.get(SEASON_KEY); return v? JSON.parse(v): []; }catch(_){ return []; }
  }
  async function saveSeason(arr){
    try{ await idbKV.set(SEASON_KEY, JSON.stringify(arr)); localStorage.setItem(SEASON_KEY, JSON.stringify(arr)); }catch(_){}
  }

  /* ===== Helpers ===== */
  function vibrate(ms=20){ if(navigator.vibrate) navigator.vibrate(ms); }
  function highlightPeriod(){
    [...$('periodChips').children].forEach(ch=>{
      const p = Number(ch.dataset.p);
      ch.classList.toggle('active', p===state.period);
      ch.setAttribute('aria-pressed', p===state.period ? 'true':'false');
    });
  }
  function fmtTime(iso){ const d=new Date(iso);
    return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
  }
  function clamp01(x){ return Math.max(0, Math.min(1, x)); }

  /* ===== Tally & events ===== */
  function bump(type, period){
    const p = per[period] || per[4];
    if(type==='shot'){ state.countsA.shots++; p.A_shots++; }
    else if(type==='goal'){ state.countsA.shots++; state.countsA.goals++; p.A_shots++; p.A_goals++; }
    else if(type==='soft_goal'){ state.countsA.shots++; state.countsA.goals++; state.countsA.softGoals++; p.A_shots++; p.A_goals++; }
    else if(type==='smother'){ state.countsA.smothers++; p.A_smothers++; }
    else if(type==='bad_rebound'){ state.countsA.badRebounds++; p.A_badRebounds++; }
    else if(type==='big_save'){ state.countsA.bigSaves++; state.countsA.shots++; p.A_bigSaves++; p.A_shots++; }
    else if(type==='for_shot'){ state.countsF.shots++; p.F_shots++; }
    else if(type==='for_goal'){ state.countsF.shots++; state.countsF.goals++; p.F_shots++; p.F_goals++; }
    else if(type==='breakaway_against'){ state.team.breakawaysAgainst++; p.BA++; }
    else if(type==='dz_turnover'){ state.team.dzTurnovers++; p.DZ++; }
  }
  function addEvent(type, meta={}){
    const ev = {type, tISO:new Date().toISOString(), period:state.period, ...meta};
    state.events.push(ev); bump(type, state.period); save(); renderAll(); vibrate();
  }
  function undo(){
    const ev = state.events.pop(); if(!ev) return;
    const p = per[ev.period] || per[4];
    if(ev.type==='shot'){ state.countsA.shots--; p.A_shots--; }
    else if(ev.type==='goal'){ state.countsA.shots--; state.countsA.goals--; p.A_shots--; p.A_goals--; }
    else if(ev.type==='soft_goal'){ state.countsA.shots--; state.countsA.goals--; state.countsA.softGoals--; p.A_shots--; p.A_goals--; }
    else if(ev.type==='smother'){ state.countsA.smothers--; p.A_smothers--; }
    else if(ev.type==='bad_rebound'){ state.countsA.badRebounds--; p.A_badRebounds--; }
    else if(ev.type==='big_save'){ state.countsA.bigSaves--; state.countsA.shots--; p.A_bigSaves--; p.A_shots--; }
    else if(ev.type==='for_shot'){ state.countsF.shots--; p.F_shots--; }
    else if(ev.type==='for_goal'){ state.countsF.shots--; state.countsF.goals--; p.F_shots--; p.F_goals--; }
    else if(ev.type==='breakaway_against'){ state.team.breakawaysAgainst--; p.BA--; }
    else if(ev.type==='dz_turnover'){ state.team.dzTurnovers--; p.DZ--; }
    save(); renderAll(); vibrate(15);
  }

  /* ===== Scoring ===== */
  function computeGoalieScore(){
    const C = state.countsA;
    const shots = C.shots, ga = C.goals, saves = Math.max(0, shots - ga);
    const sv    = shots>0 ? (saves/shots) : 1;

    const defensiveDen = Math.max(1, saves + ga + C.smothers);
    const badRate      = clamp01(C.badRebounds / defensiveDen);
    let scoreRebound   = 20 * (1 - badRate);
    const smotherRate  = defensiveDen>0 ? clamp01(C.smothers / defensiveDen) : 0;
    scoreRebound += Math.min(4, 4 * smotherRate);
    scoreRebound = Math.max(0, Math.min(20, scoreRebound));

    const scoreSV   = shots>0 ? 60 * sv : 50;
    const scoreSoft = Math.max(0, 10 - 5 * C.softGoals);
    const scoreBig  = Math.min(10, 2 * C.bigSaves);

    let total = Math.round(scoreSV + scoreRebound + scoreSoft + scoreBig);
    if(total<0) total=0; if(total>100) total=100;

    return {shots, ga, saves, sv, scoreSV, scoreRebound, scoreSoft, scoreBig, total,
            badRate, smotherRate};
  }

  function computeTeamScore(){
    const SF = state.countsF.shots, SA = state.countsA.shots;
    const GF = state.countsF.goals, GA = state.countsA.goals;

    // 1) Shot share
    const SS = (SF+SA)>0 ? SF/(SF+SA) : 0.5;
    const scoreSS = 35 * SS;

    // 2) Finishing (cap at 30%)
    const Fin = SF>0 ? GF/SF : 0;
    const scoreFin = 20 * Math.min(1, Fin/0.30);

    // 3) Impact per shot (normalized around 0.5)
    const d = (GF - GA)/Math.max(1, SF+SA);
    const Impact = clamp01(0.5 + 3*d);
    const scoreImp = 30 * Impact;

    // 4) Consistency (stability of SS by period)
    const ssPeriods = [1,2,3,4].map(p=>{
      const sfp = per[p].F_shots, sap = per[p].A_shots;
      const den = (sfp + sap);
      return den>0 ? (sfp/den) : null;
    }).filter(v=>v!==null);
    let sigma = 0;
    if(ssPeriods.length>1){
      const mu = ssPeriods.reduce((a,b)=>a+b,0)/ssPeriods.length;
      const varr = ssPeriods.reduce((a,b)=>a+(b-mu)*(b-mu),0)/ssPeriods.length;
      sigma = Math.sqrt(varr);
    }
    const Stability = clamp01(1 - (sigma/0.25));
    const scoreStab = 15 * Stability;

    // Modifiers
    const BA = state.team.breakawaysAgainst || 0;
    const DZ = state.team.dzTurnovers || 0;
    const modBA = Math.min(10, 2*BA); // -2 each, cap -10
    const modDZ = Math.min(8, 1*DZ);  // -1 each, cap -8

    let total = Math.round(scoreSS + scoreFin + scoreImp + scoreStab - modBA - modDZ);
    if(total<0) total=0; if(total>100) total=100;

    return {total, scoreSS, scoreFin, scoreImp, scoreStab, BA, DZ, SS, Fin, Impact, Stability};
  }

  function shotShare(){
    const sf = state.countsF.shots, sa = state.countsA.shots;
    const denom = sf + sa;
    return denom>0 ? (sf/denom) : 0.5;
  }

  /* ===== Player tallies (S/G/A) ===== */
  function perPlayerTallies(){
    const shots = new Map(), goals = new Map(), assists = new Map(), all=new Set();
    for(const ev of state.events){
      if(ev.type==='for_shot' && ev.player){ shots.set(ev.player,(shots.get(ev.player)||0)+1); all.add(ev.player); }
      if(ev.type==='for_goal'){
        if(ev.player){ goals.set(ev.player,(goals.get(ev.player)||0)+1); all.add(ev.player); }
        if(ev.assist && ev.assist!=='None'){ assists.set(ev.assist,(assists.get(ev.assist)||0)+1); all.add(ev.assist); }
      }
    }
    const order=[...all].sort((a,b)=>{const na=+a, nb=+b; const an=isNaN(na), bn=isNaN(nb); if(an&&bn) return (''+a).localeCompare(''+b); if(an) return 1; if(bn) return -1; return na-nb;});
    return {shots, goals, assists, order};
  }

  /* ===== Render ===== */
  function updateMeta(){
    $('gameMetaTag').textContent =
      `${state.opponent||'Opponent?'} • ${state.level||'U11'} • ${state.date||new Date().toISOString().slice(0,10)}`;
  }

  function refreshStats(){
    const A = state.countsA, F = state.countsF, T = state.team;
    const K = computeGoalieScore();
    const Team = computeTeamScore();

    $('shotsVal').textContent = A.shots;
    $('savesVal').textContent = K.saves;
    $('gaVal').textContent    = A.goals;
    $('svVal').textContent    = (K.sv*100).toFixed(1)+'%';
    $('smotherVal').textContent = A.smothers;
    $('brVal').textContent      = A.badRebounds;
    $('bigVal').textContent     = A.bigSaves;
    $('sfVal').textContent      = F.shots;
    $('gfVal').textContent      = F.goals;
    $('shootVal').textContent   = F.shots>0 ? ((F.goals/F.shots*100).toFixed(0)+'%') : '—';
    $('ssVal').textContent      = ((shotShare()*100)|0) + '%';
    $('baVal').textContent      = T.breakawaysAgainst||0;
    $('dzVal').textContent      = T.dzTurnovers||0;
    $('teamScoreVal').textContent = Team.total;

    const phtml = [1,2,3,4].map(p=>{
      const v = per[p];
      const aSaves = Math.max(0, v.A_shots - v.A_goals);
      const aSVP = v.A_shots ? ((aSaves/v.A_shots)*100).toFixed(0)+'%' : '—';
      const title = p===4?'OT':`P${p}`;
      return `<div class="pchip"><h4>${title}</h4>
                <div>SF-SA ${v.F_shots}-${v.A_shots} • GF-GA ${v.F_goals}-${v.A_goals} • SV ${aSVP}</div>
              </div>`;
    }).join('');
    $('periodSummary').innerHTML = phtml;

    const gsEl = $('goalieScoreNum'), tsEl = $('teamScoreNum');
    if (gsEl && tsEl) {
      gsEl.textContent = K.total;
      tsEl.textContent = Team.total;
      [gsEl, tsEl].forEach(el => { el.classList.remove('good','warn','bad'); });
      gsEl.classList.add(K.total>=85?'good':K.total>=70?'warn':'bad');
      tsEl.classList.add(Team.total>=85?'good':Team.total>=70?'warn':'bad');
    }
  }

  function refreshLog(){
    $('log').innerHTML = state.events.slice(-200).map(ev=>{
      let label = ev.type.replace('soft_goal','Soft Goal').replace('bad_rebound','Bad Rebound')
                         .replace('for_shot','Our Shot').replace('for_goal','Our Goal')
                         .replace('breakaway_against','Breakaway Against').replace('dz_turnover','D-Zone Turnover')
                         .replace('_',' ');
      if(ev.player) label += ` (#${ev.player})`;
      if(ev.type==='for_goal' && ev.assist){ label += ` A:${ev.assist==='None'?'—':('#'+ev.assist)}`; }
      return `<div class="item">P${ev.period} • ${fmtTime(ev.tISO)} — ${label}</div>`;
    }).join('');
    $('log').scrollTop = $('log').scrollHeight;
  }

  function makeSummaryTable(){
    const rows = [];
    const header = `<table><thead><tr>
      <th>Period</th><th>Shots For</th><th>Shots Against</th><th>Goals For</th><th>Goals Against</th><th>Save %</th>
    </tr></thead><tbody>`;
    for(const p of [1,2,3,4]){
      const v = per[p];
      const saves = Math.max(0, v.A_shots - v.A_goals);
      const svp = v.A_shots? ((saves/v.A_shots)*100).toFixed(0)+'%':'—';
      const title = p===4?'OT':p;
      rows.push(`<tr><td>${title}</td><td>${v.F_shots}</td><td>${v.A_shots}</td><td>${v.F_goals}</td><td>${v.A_goals}</td><td>${svp}</td></tr>`);
    }
    const F = state.countsF, A = state.countsA;
    const totalSaves = Math.max(0, A.shots - A.goals);
    const totalSVP = A.shots? ((totalSaves/A.shots)*100).toFixed(0)+'%':'—';
    rows.push(`<tr><th>Total</th><th>${F.shots}</th><th>${A.shots}</th><th>${F.goals}</th><th>${A.goals}</th><th>${totalSVP}</th></tr>`);
    const tbl = header + rows.join('') + `</tbody></table>`;

    // Per-player table for summary
    const T = perPlayerTallies();
    const playerRows = T.order.map(n=>{
      return `<tr><td>#${n}</td><td>${T.shots.get(n)||0}</td><td>${T.goals.get(n)||0}</td><td>${T.assists.get(n)||0}</td></tr>`;
    }).join('');
    const playersTbl = `
      <div class="card" style="margin-top:10px;">
        <h3>Players</h3>
        <table style="margin-top:6px;">
          <thead><tr><th>Player</th><th>Shots</th><th>Goals</th><th>Assists</th></tr></thead>
          <tbody>${playerRows||'<tr><td colspan="4">—</td></tr>'}</tbody>
        </table>
      </div>`;
    return tbl + playersTbl;
  }

  function playerLinesText(){
    const T = perPlayerTallies();
    if(T.order.length===0) return 'Players: —';
    return 'Players: ' + T.order.map(n=>`#${n} ${(T.shots.get(n)||0)}S/${(T.goals.get(n)||0)}G/${(T.assists.get(n)||0)}A`).join(' • ');
  }

  function renderAll(){ highlightPeriod(); updateMeta(); refreshStats(); refreshLog(); }

  /* ===== Summary Screen ===== */
  function endGame(){
    const K = computeGoalieScore();
    const Team = computeTeamScore();

    const title = `${state.opponent||'Opponent'} • ${state.level} • ${state.date||new Date().toISOString().slice(0,10)}`;
    $('summaryTitle').textContent = `Game Summary — ${title}`;

    const gsEl = $('goalieScoreNum');
    const tsEl = $('teamScoreNum');
    gsEl.textContent = K.total;
    tsEl.textContent = Team.total;
    [gsEl, tsEl].forEach(el => { el.classList.remove('good','warn','bad'); });
    gsEl.classList.add(K.total>=85?'good':K.total>=70?'warn':'bad');
    tsEl.classList.add(Team.total>=85?'good':Team.total>=70?'warn':'bad');

    $('scoreBreakdown').innerHTML =
      `SV%: ${(K.sv*100).toFixed(1)}% → ${K.scoreSV.toFixed(1)}<br>
       Rebound: ${K.scoreRebound.toFixed(1)} (bad/def ${(K.badRate*100).toFixed(0)}%, smother ${(K.smotherRate*100).toFixed(0)}%)<br>
       Soft goals: +${K.scoreSoft.toFixed(1)}<br>
       Big saves: +${K.scoreBig.toFixed(1)}`;

    $('summaryTableWrap').innerHTML = makeSummaryTable();
    $('playerLines').textContent = playerLinesText();
    $('teamExtras').textContent = `BA: ${state.team.breakawaysAgainst||0} • D-Zone TO: ${state.team.dzTurnovers||0}`;

    $('summaryPanel').classList.remove('hidden');

    appendToSeasonLog(K, Team);
    window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
  }

  /* ===== CSV ===== */
  function buildGameRow(K, Team){
    const F=state.countsF, A=state.countsA;
    return {
      date: state.date || new Date().toISOString().slice(0,10),
      opponent: state.opponent||'',
      level: state.level||'',
      teamScore: Team.total,
      goalieScore: K.total,
      SF: F.shots, SA: A.shots, GF: F.goals, GA: A.goals,
      savePct: (K.sv*100).toFixed(1),
      smothers: A.smothers, badRebounds: A.badRebounds, bigSaves: A.bigSaves, softGoals: A.softGoals,
      breakawaysAgainst: state.team.breakawaysAgainst||0, dzTurnovers: state.team.dzTurnovers||0
    };
  }
  function rowToCSV(row, header){ return header.map(k=>typeof row[k]==='string'?JSON.stringify(row[k]):row[k]).join(','); }
  async function appendToSeasonLog(K, Team){
    const row = buildGameRow(K, Team);
    const existing = await loadSeason();
    existing.push(row);
    await saveSeason(existing);
  }
  function seasonCSV(rows){
    const header=["date","opponent","level","teamScore","goalieScore","SF","SA","GF","GA","savePct",
      "smothers","badRebounds","bigSaves","softGoals","breakawaysAgainst","dzTurnovers"];
    const lines=[header.join(',')];
    rows.forEach(r=>lines.push(rowToCSV(r,header)));
    return lines.join('\r\n');
  }
  // GAME CSV includes a per-player table after a blank line
  function gameCSV(){
    const k=computeGoalieScore(), t=computeTeamScore();
    const line1 = seasonCSV([buildGameRow(k,t)]);
    const T = perPlayerTallies();
    const header = 'player,shots,goals,assists';
    const rows = T.order.map(n=>`${JSON.stringify('#'+n)},${T.shots.get(n)||0},${T.goals.get(n)||0},${T.assists.get(n)||0}`).join('\r\n');
    return line1 + '\r\n\r\n' + header + '\r\n' + rows + '\r\n';
  }
  async function shareCSV(csvText, filename){
    try{
      const blob = new Blob([csvText], { type:'text/csv;charset=utf-8' });
      const supportsShareFiles = !!(navigator.canShare && window.File);
      if(supportsShareFiles){
        const file = new File([blob], filename, { type:'text/csv' });
        if(navigator.canShare({files:[file]})){
          await navigator.share({ files:[file], title: filename });
          return;
        }
      }
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=filename; a.rel='noopener';
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url),1500);
      setTimeout(()=>{ try{ window.open(url,'_blank'); }catch(_){} }, 50);
    }catch(_){ openCopyModal(csvText); }
  }

  /* ===== Copy modal ===== */
  function openCopyModal(text){ $('copyArea').value=text; $('copyModal').style.display='flex'; setTimeout(()=>{$('copyArea').focus(); $('copyArea').select();},50); }
  $('btnCopySelect').addEventListener('click', ()=>{ $('copyArea').focus(); $('copyArea').select(); });
  $('btnCopyClose').addEventListener('click', ()=>{ $('copyModal').style.display='none'; });

  /* ===== Roster & Picker ===== */
  function openRoster(){ $('rosterArea').value=(state.roster||[]).join('\n'); $('rosterModal').style.display='flex'; }
  function closeRoster(){ $('rosterModal').style.display='none'; }
  function saveRosterFromArea(){
    const lines=$('rosterArea').value.split('\n').map(s=>s.trim()).filter(Boolean);
    const uniq = Array.from(new Set(lines));
    uniq.sort((a,b)=>{const na=+a, nb=+b; const an=isNaN(na), bn=isNaN(nb); if(an&&bn) return (''+a).localeCompare(''+b); if(an) return 1; if(bn) return -1; return na-nb;});
    state.roster=uniq; localStorage.setItem(ROSTER_KEY, JSON.stringify(state.roster)); save(); closeRoster();
  }

  // Picker flow: scorer -> assist
  let pendingType=null, pendingScorer=null;
  function openPicker(type, title='Select player number'){
    pendingType=type;
    buildPickerGrid();
    $('pickerTitle').textContent = title;
    $('pickerInput').value='';
    $('pickerModal').style.display='flex';
  }
  function closePicker(){ $('pickerModal').style.display='none'; pendingType=null; }

  function buildPickerGrid(){
    const grid = $('pickerGrid'), roster = (state.roster||[]);
    const uniq = Array.from(new Set(roster.map(x=>String(x).trim()).filter(Boolean)));
    uniq.sort((a,b)=>{const na=+a, nb=+b; const an=isNaN(na), bn=isNaN(nb); if(an&&bn) return (''+a).localeCompare(''+b); if(an) return 1; if(bn) return -1; return na-nb;});
    grid.innerHTML = uniq.length? uniq.map(n=>`<div class="pickerBtn" data-n="${n}">#${n}</div>`).join('')
                                : `<div class="small">No roster yet. Add numbers in the Roster menu.</div>`;
  }

  // Click buttons
  $('pickerGrid').addEventListener('click', e=>{
    const b=e.target.closest('.pickerBtn'); if(!b||!pendingType) return;
    handlePickerSelection(b.dataset.n);
  });
  $('pickerAdd').addEventListener('click', ()=>{
    if(!pendingType) return;
    const v=$('pickerInput').value.trim(); if(!v) return;
    handlePickerSelection(v,true);
  });
  $('pickerUnknown').addEventListener('click', ()=>{ if(!pendingType) return; handlePickerSelection('?',true); });
  $('pickerCancel').addEventListener('click', ()=>{ closePicker(); pendingScorer=null; });

  function handlePickerSelection(num, allowAdd){
    if(pendingType==='for_shot'){
      addEvent('for_shot',{player:num});
      if(allowAdd && !state.roster.includes(num)){ state.roster.push(num); state.roster.sort((a,b)=>+a-+b); localStorage.setItem(ROSTER_KEY, JSON.stringify(state.roster)); }
      closePicker();
      return;
    }
    if(pendingType==='for_goal_scorer'){
      pendingScorer = num;
      if(allowAdd && !state.roster.includes(num)){ state.roster.push(num); state.roster.sort((a,b)=>+a-+b); localStorage.setItem(ROSTER_KEY, JSON.stringify(state.roster)); }
      // now ask for assist
      $('pickerModal').style.display='none';
      // Brief pause to avoid double-tap feeling
      setTimeout(()=>{ openPicker('for_goal_assist','Select assist (optional)'); }, 80);
      return;
    }
    if(pendingType==='for_goal_assist'){
      const assist = num==='?' ? 'Unknown' : num;
      addEvent('for_goal',{player: pendingScorer, assist});
      pendingScorer=null;
      closePicker();
      return;
    }
    // generic goal legacy
    if(pendingType==='for_goal'){
      addEvent('for_goal',{player:num});
      closePicker();
    }
  }

  /* ===== Wiring main buttons ===== */
  $('btnShot').addEventListener('click', ()=>addEvent('shot'));
  $('btnBigSave').addEventListener('click', ()=>addEvent('big_save'));
  $('btnGoal').addEventListener('click', ()=>addEvent('goal'));
  $('btnSoftGoal').addEventListener('click', ()=>addEvent('soft_goal'));
  $('btnSmother').addEventListener('click', ()=>addEvent('smother'));
  $('btnBadRebound').addEventListener('click', ()=>addEvent('bad_rebound'));
  $('btnForShot').addEventListener('click', ()=>openPicker('for_shot','Select shooter'));
  $('btnForGoal').addEventListener('click', ()=>{
    // scorer first, then assist
    openPicker('for_goal_scorer','Select goal scorer');
  });
  $('btnBreakaway').addEventListener('click', ()=>addEvent('breakaway_against'));
  $('btnDZTurnover').addEventListener('click', ()=>addEvent('dz_turnover'));
  $('btnUndo').addEventListener('click', undo);
  $('btnNextPeriod').addEventListener('click', async ()=>{
    state.period = Math.min(4, state.period+1);
    highlightPeriod(); await save(); vibrate(10);
  });
  $('btnEnd').addEventListener('click', endGame);

  // Full reset clears summary too
  $('btnReset').addEventListener('click', ()=>{
    if(confirm('Start a new game? This will clear the current log.')){
      $('summaryPanel').classList.add('hidden');
      $('summaryTitle').textContent='Game Summary';
      $('goalieScoreNum').textContent='—'; $('teamScoreNum').textContent='—';
      $('scoreBreakdown').textContent=''; $('summaryTableWrap').innerHTML='';
      $('playerLines').textContent=''; $('teamExtras').textContent='';

      state.opponent=''; state.level='U11'; state.date=null; state.period=1;
      state.startedAt=new Date().toISOString(); state.gameId=Math.random().toString(36).slice(2);
      state.events=[]; state.countsA={shots:0, goals:0, softGoals:0, smothers:0, badRebounds:0, bigSaves:0};
      state.countsF={shots:0, goals:0}; state.team={breakawaysAgainst:0, dzTurnovers:0};
      per = {1:initP(),2:initP(),3:initP(),4:initP()};
      $('opponent').value=''; $('level').value='U11'; $('date').valueAsDate=new Date();
      $('resumeBanner').classList.add('hidden');
      save(); renderAll(); highlightPeriod(); window.scrollTo({top:0,behavior:'smooth'});
    }
  });

  $('btnExportGameCSV').addEventListener('click', ()=> shareCSV(gameCSV(), 'teamtracker_game.csv'));
  $('btnExportSeasonCSV').addEventListener('click', async ()=>{
    const rows = await loadSeason();
    if(!rows.length){ openCopyModal('Season log is empty.\r\nFinish a game (End Game & Score) to add your first row.'); return; }
    shareCSV(seasonCSV(rows), 'teamtracker_season.csv');
  });

  // roster & picker
  $('btnRoster').addEventListener('click', openRoster);
  $('btnRosterSave').addEventListener('click', saveRosterFromArea);
  $('btnRosterClose').addEventListener('click', closeRoster);

  // inputs
  $('opponent').addEventListener('input', e=>{ state.opponent=e.target.value; save(); updateMeta(); });
  $('level').addEventListener('change',  e=>{ state.level=e.target.value; save(); updateMeta(); });
  $('date').addEventListener('change',   e=>{ state.date=e.target.value;  save(); updateMeta(); });
  $('periodChips').addEventListener('click', async e=>{
    const chip=e.target.closest('.chip'); if(!chip) return;
    const newP = Number(chip.dataset.p);
    if(newP!==state.period){ state.period=newP; highlightPeriod(); await save(); }
  });

  // modals close on backdrop click
  $('rosterModal').addEventListener('click', (e)=>{ if(e.target === $('rosterModal')) closeRoster(); });
  $('pickerModal').addEventListener('click', (e)=>{ if(e.target === $('pickerModal')) closePicker(); });
  $('copyModal').addEventListener('click',   (e)=>{ if(e.target === $('copyModal')) $('copyModal').style.display='none'; });

  // extra saves
  window.addEventListener('pagehide', save);
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState!=='visible') save(); });
  setInterval(save, 5000);

  /* ===== Init ===== */
  (async function init(){
    $('date').valueAsDate = new Date();
    await persistStorage();
    try{
      const r = localStorage.getItem(ROSTER_KEY);
      state.roster = r ? JSON.parse(r) : [];
      state.roster.sort((a,b)=>{const na=+a, nb=+b; const an=isNaN(na), bn=isNaN(nb); if(an&&bn) return (''+a).localeCompare(''+b); if(an) return 1; if(bn) return -1; return na-nb;});
    }catch(_){ state.roster=[]; }

    const loaded = await load();
    if (loaded && Array.isArray(loaded.events)) {
      Object.assign(state, loaded);
      per = {1:initP(),2:initP(),3:initP(),4:initP()};
      for(const ev of state.events){ bump(ev.type, ev.period); }
      $('resumeBanner').classList.remove('hidden');
    }

    updateMeta(); renderAll();
  })();
</script>
</body>
</html>
